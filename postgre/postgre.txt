
**** Postgresql integration with docker and create first DB ****

0.  Postgresql documentation:

    https://www.postgresql.org/docs/9.4/static/app-postgres.html
    https://www.postgresql.org/

1.  Wildfly docker integrated with Postgresql server:

    https://hub.docker.com/r/rackerlabs/wildfly-postgres/~/dockerfile/
    https://github.com/nkrendel/wildfly-docker

2.  Postgresql docker
    https://github.com/sameersbn/docker-postgresql

3.  Postgresql deploying and running on docker, examples
    https://docs.docker.com/engine/examples/postgresql_service/
    https://blog.danivovich.com/2015/06/29/running-postgres-in-docker/
    https://clusterhq.com/2016/01/08/tutorial-flocker-volume-driver-postgres/


https://hub.docker.com/_/postgres/

docker pull postgres

docker run --name aelz-postgre -e POSTGRES_PASSWORD=aelzpassword -d postgres

**  Start with port mapping ***
docker run --name some-postgres -e POSTGRES_PASSWORD=aelzpassword -d -p 5432:5432 postgres

docker exec -it some-postgres bash

** Connect with psql clinet **
psql -h localhost -p 5432 -U postgres -W


OR

psql  -U postgres

OR

when start docker:
-----------------
docker run --name postgresql -itd --restart always --env 'DB_USER=fr_user' --env 'DB_PASS=fraud'  --env 'DB_NAME=fraud_db' sameersbn/postgresql:9.6-2

docker exec -it postgresql sudo -u postgres psql fraud_db

create schema subsc_act;
CREATE TABLE subsc_act.subcriber_info (
    imsi BIGINT NOT NULL,
    msisdn TEXT,
    PRIMARY KEY (imsi));


connect to DB from commandline
------------------------------
psql -U postgres

su - postgres -u
source /opt/rh/rh-postgresql96/enable
psql -d notifierdb

**show all db databases and tables **
\list                   # list of all DBs
\c user_db              # connect to specific db
\d db1        # dump relation

select * from db1;

INSERT INTO streamer_streamer VALUES ( nextval('streamer_streamer_id_seq'::regclass) ,'MAJOR', TRUE, '2017-03-03',
'2017-02-02', 'aelz_origin', 222, 'SPEC_Problem', 'ADDIT TEXT OF SPEC PROBLEM');

*** count number records in table:
SELECT COUNT(*) FROM TABLE_NAME;
ALTER USER postgres PASSWORD 'custom-pwd';

# access to schema.table
select * from tenant34."asset_inventory_interface";


Troubleshooting
---------------

- flows/adp_pg.txt
- transcation log corruption (could not locate a valid checkpoint record)
 https://stackoverflow.com/questions/8799474/postgresql-error-panic-could-not-locate-a-valid-checkpoint-record




PG_STAT  commands
-----------------

1. Number of transcactions  overall / per db


postgres=# SELECT sum(xact_commit+xact_rollback) FROM pg_stat_database;

   sum
---------
 1077119
(1 row)

postgres=# SELECT xact_commit+xact_rollback FROM pg_stat_database WHERE datname = 'xxx';
 ?column?
----------
   525471
(1 row)



*********************** pg_stat total execution time ******

configure pg_stat in preloaded library:
https://severalnines.com/blog/how-identify-postgresql-performance-issues-slow-queries/


pgbench=# CREATE EXTENSION pg_stat_statements;

CREATE EXTENSION


select pg_stat_statements_reset();


 SELECT substring(query, 1, 50) AS short_query,
              round(total_exec_time::numeric, 2) AS total_exec_time,
              calls,
              round(mean_exec_time::numeric, 2) AS mean,
              round((100 * total_exec_time /
              sum(total_exec_time::numeric) OVER ())::numeric, 2) AS percentage_cpu
FROM    pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;


###  detailed view of top requests 
select userid::regrole, dbid, query
    from pg_stat_statements
    order by total_exec_time desc
    limit 10;

